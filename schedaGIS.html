<html>

<head>

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
	<!-- Make sure you put this AFTER Leaflet's CSS -->
 	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.0/MarkerCluster.Default.min.css" />
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script> -->

	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.js" integrity="sha512-ceQPs2CHke3gSINLt/JV37W1rfJOM64yuH999hnRhTP7tNtcSBp5hlTKhn8CEIhsFweSBrZMPVotAKjoyxGWNg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.css" integrity="sha512-efbAfGnrnjA+hLwOLu91W034fBGPsMwZMVCTwLUI2PDX/m7rOiuhYZ+D2mZ8rKcpC/I/7pdgoL8T4eYvMHNoQg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha512-ozq8xQKq6urvuU6jNgkfqAmT7jKN2XumbrX1JiB3TnF7tI48DPI4Gy1GXKD/V3EExgAs1V+pRO7vwtS1LHg0Gw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" integrity="sha512-gc3xjCmIy673V6MyOAZhIW93xhM9ei1I+gLbmFjUHIjocENRsLX/QUE1htk5q1XV2D/iie/VQ8DXI6Vu8bexvQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

	<script src="https://cdn.jsdelivr.net/npm/leaflet-measure@3.1.0/dist/leaflet-measure.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/leaflet-measure@3.1.0/dist/leaflet-measure.min.css" rel="stylesheet">

	<script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.min.css" rel="stylesheet">

	<script src="https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.5/dist/leaflet.awesome-markers.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.5/dist/leaflet.awesome-markers.min.css" rel="stylesheet">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/4.6.6/alasql.min.js"></script> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.core.min.js"></script>

	<link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">
 	<script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>

	<link rel="stylesheet" href="styleGeoInf.css">

	<style>

	</style>

</head>

<body style = "overflow-y: scroll" >
	
	<div>
		Cartografia in ambito Web-GIS, alcuni esempi. 
		<br>
		<br>
		<b>
			*** ATTENZIONE ***: gli elementi richiamati nel seguito appartengono ai rispettivi proprietari. 
		</b>
		<br>
		<br>
		
	</div>

	<div id="tabellaGIS" class="grid">

		<div id = "blocco01GIS" class = "span4 roundBorder" >

			<div id="totMap02" style ="width: 100%; ">  
				<div id="titleDescrMap02" >
					<p> <u>Mappa Leaflet</u>:  </p> 
					<br>
					- Link GitHub di riferimento: <a href="https://github.com/planetsig/ufo-reports">Ufo Reports Dataset</a>; 
					<br>
					- Link al file CSV: <a href="https://raw.githubusercontent.com/planetsig/ufo-reports/master/csv-data/ufo-scrubbed-geocoded-time-standardized.csv">File CSV</a>; 
					<br>
					- Articolo di riferimento: <a href="https://drlee.io/exploring-ufo-sightings-with-python-pandas-and-google-colab-3cf24d1843d3">Exploring UFO Sightings with Python, Pandas, and Google Colab</a>; 
					<br> 
					<!-- - Impiego della Libreria Python <a href="https://python-visualization.github.io/folium/latest/">Folium</a>;
					<br> -->
					- Impiego delle Librerie <a href="https://leafletjs.com/">Leaflet</a>, <a href="https://turfjs.org/">Turf</a>;
					<br>
					- JavaScript SQL Database, per tabelle relazionali tradizionali e dati JSON annidati (NoSQL): <a href="https://alasql.org/">AlaSQL</a>, <a href="https://github.com/alasql/alasql/wiki/XLSX">XLSX</a>.
					<br>
					- Legende eventualmente presenti: <a href="https://www.cyclosm.org/legend.html">CyclOsmMap Legend</a>.
					<br>
					*** Nota: la variazione dell'anno di riferimento o l'esecuzione di una query SQL consentono l'aggiornamento degli avvistamenti ottenuti in mappa o nel seguito. 
					<br>
					*** Nota FLUTTER: flutter_map wants to help keep map data available for everyone; we use the OpenStreetMap public tile servers in our code examples & demo app, but they are NOT free to use by everyone;please review whether OSM's tile servers are appropriate and the best choice for your app; see: <a href="https://operations.osmfoundation.org/policies/tiles">OSM Tile Usage Policy</a>, <a href="https://docs.fleaflet.dev/osm-warn">OSM-WARN</a> for more information about this warning.
					<br>
					<br>
				</div>

				<div id="contMap02" style="float: left; width: 85%; "> <!-- overflow: hidden; height: 60vh -->
					<div id="leafletMap02" style="height: 60vh; border: 2px solid " ></div> 
				</div>

				<div id="contControlMap02" style="float: right; width: 14%; height: 60vh; " > <!-- overflow-x: scroll; overflow-y: scroll; -->
					<div id="contControlMap02ParteSup" >
						<p class= "justify" >Informazioni sulla mappa lato Leaflet: </p> 
						<table style="width: 100%;" >
							<tr>
								<td style="width: 35%; " ><input type="text" value="- Lat: " style="width: 100%; border: none; font-family: 'Trebuchet MS';" readonly></input></td>
								<td style="width: 65%; " ><input id="txt_latMap02" type="text" style="width: 100%; font-family: 'Trebuchet MS';" value = "--" readonly></input></td>
							</tr>
							<tr>
								<td style="width: 35%; " ><input type="text" value="- Lng: " style="width: 100%; border: none; font-family: 'Trebuchet MS';" readonly></input></td>
								<td style="width: 65%; " ><input id="txt_lngMap02" type="text" style="width: 100%; font-family: 'Trebuchet MS';" value = "--" readonly></input></td>
							</tr>
							<tr>
								<td style="width: 35%; " ><input type="text" value="- Zoom: " style="width: 100%; border: none; font-family: 'Trebuchet MS';" readonly></input></td>
								<td style="width: 65%; " ><input id="txt_zoomMap02" type="text" style="width: 100%; font-family: 'Trebuchet MS';" value = "3.00" readonly></input></td>
							</tr>
						</table>

						<hr/>

						Avvistamenti UFO nell'anno <input id="txt_annoAvvistamentoUFO" type="text" min="1906" max="2014" value="1987" style="width: 6vh; font-family: 'Trebuchet MS'; font-weight:bold; " maxlength="4" onblur="if( isNaN( this.value ) ) { this.value = '1987' } else { eseguiQueryUfoDb( '' ); } " > 
						<br>
						<u>(la perdita del focus sul campo avvia la visualizzazione degli eventuali Marker sulla mappa)</u> <!-- type='number' -->
						<br>
						<hr/>

						Console: 
					</div>
					<div id="contControlMap02ParteInf" >
						<textarea id="consoleMap02" style="width: 100%; resize: none; overflow: scroll; font-family: 'Trebuchet MS';" readonly ></textarea>
					</div>
				</div>

			</div>

			<script>
				//contFoliumMapOffsetHeight = document.getElementById( "contFoliumMap" ).offsetHeight;  
				//offsetWidth_contFoliumMap = document.getElementById( "contFoliumMap" ).offsetWidth; 
				
				//var testArray = [ 1, 2, 3 ]

				//consoleMap02
				document.getElementById( "consoleMap02" ).style.height = document.getElementById( "contMap02" ).offsetHeight - document.getElementById("contControlMap02ParteSup" ).offsetHeight; 

				var map02 = L.map('leafletMap02' , { 
					zoomSnap: 1 , //1
					zoomDelta : 1, 
					wheelPxPerZoomLevel: 90, //60 

				} ).setView([ 46.035235, 10.980633], 3);

				var baseOSM = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
					maxZoom: 19,
				}).addTo(map02);

				/*
				var baseCartoDarkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
					maxZoom: 19,
				}).addTo(map02);
				*/

				var baseCyclOsmMap = L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
					maxZoom: 15,
				}).addTo(map02);

				var baseOpenTopoMap = L.tileLayer('https://tile.opentopomap.org/{z}/{x}/{y}.png', {
					maxZoom: 16,
				}).addTo(map02);

				var baseGoogleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
					maxZoom: 19,
				}).addTo(map02);

				var baseGoogleSatellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
					maxZoom: 19,
				}).addTo(map02);

				var baseGoogleRoad = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
					maxZoom: 19,
				}).addTo(map02);

				/*
				var baseStadiaMap = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}{r}.png', {
					maxZoom: 19,
				}).addTo(map02);
				*/

				map02.addEventListener('mousemove', function( e ) {
					//innerHTML textArea
					document.getElementById( "txt_latMap02" ).value  = ( e.latlng.lat ).toFixed( 6 ); 
					document.getElementById( "txt_lngMap02" ).value  = ( e.latlng.lng ).toFixed( 6 );
				});

				map02.addEventListener('zoomend', function( e ) {
					//innerHTML textArea
					document.getElementById( "txt_zoomMap02" ).value  = ( map02.getZoom() ).toFixed( 2 );
				});

				baseMaps = {
					"OpenStreetMap": baseOSM,
					//"CartoDarkMap": baseCartoDarkMap, 
					"CyclOsmMap": baseCyclOsmMap,
					"OpenTopoMap": baseOpenTopoMap,
					"Google Hybrid": baseGoogleHybrid,
					"Google Satellite": baseGoogleSatellite,
					"Google Road": baseGoogleRoad,
				}

				//map02.addLayer( layerDrawItems );
				/* OVERLAYDrawing */ 
				var layerDrawItems = new L.FeatureGroup();
				var layerMarkers = new L.FeatureGroup();
				//overlayMaps[ "layerDrawItems" ] = layerDrawItems; 
				//overlayMaps[ "layerMarkers" ] = layerMarkers;

				var overlayMaps = {
					//GeoJSON data initialization 
					"layerDrawItems" : layerDrawItems, 
					"layerMarkers" : layerMarkers,
				};

				var layerControl = L.control.layers(baseMaps, overlayMaps).addTo( map02 );

				var layerMiniMap = L.tileLayer( 'https://tile.openstreetmap.org/{z}/{x}/{y}.png' ); 
				var miniMap = new L.Control.MiniMap( layerMiniMap , { 
					toggleDisplay : true , 
					width: Math.round( window.screen.width /15 ), 
					height: Math.round( window.screen.height /15 ) , 
				} ).addTo(map02);
				
				//**//

				//layerControl.remove( map02 );
				//layerControl = L.control.layers(baseMaps, overlayMaps).addTo( map02 );

				var drawControl = new L.Control.Draw({
					edit: {
						featureGroup: layerDrawItems,
					},
					draw: {
						polyline: {	metric: 'metric' },
						polygon : { metric: 'metric' },
						rectangle: { metric: 'metric' },  
						circle: { metric: 'metric' },
						marker: { metric: 'metric' }, 
						circlemarker: { metric: 'metric' }, 
					},
				});
				
				map02.addControl(drawControl);

				map02.on( "draw:created" , function( e ) {
					var type = e.layerType; 
					var layer = e.layer; 

					var popup = L.popup().setContent( "" + JSON.stringify( layer.toGeoJSON() ) );

					layer.bindPopup( popup ); 
					console.log( layer.toGeoJSON() );
					document.getElementById( "consoleMap02" ).value += 
						"- Type of Feature: " + type + "\n";
					
					layerDrawItems.addLayer( layer ); 
				}); 

				map02.on( "draw:edited" , function( e ) {
					var type = e.layerType; 
					var layer = e.layer; 
					document.getElementById( "consoleMap02" ).value += "- draw : edited" + "\n";

				}); 

				//Mappe, Layer visibili
				var click_elements = document.getElementsByClassName("leaflet-control-layers-selector");
				//for( var i = 0; i < click_elements.length; i++ ) {
					//console.log( click_elements[ i ] ); 
				//}
				//click_elements.length

				click_elements[ 5 ].click(); //baseMaps

				click_elements[ click_elements.length - 2 ].click(); //layerDrawItems
				click_elements[ click_elements.length - 1 ].click(); //layerMarkers //Vedi funzione seguente

				var measureControl = new L.Control.Measure( { primaryLengthUnit: "kilometers" , primaryAreaUnit: "sqmeters" } );

				// Disable auto-pan by overriding the pluginâ€™s internal method(s):
				L.Control.Measure.include({
					// Prevent auto-panning when the capture marker is placed
					_setCaptureMarkerIcon: function () {
						// Turn off autoPan
						this._captureMarker.options.autoPanOnFocus = false;
						// Call the original icon setup
						this._captureMarker.setIcon(
						L.divIcon({
							iconSize: this._map.getSize().multiplyBy(2),
						})
						);
					},

					// Optionally, override _startMeasure or other private methods if needed
					// _startMeasure: function () {
						//   // Your custom override
					// },
					});

				measureControl.addTo( map02 );
				
			</script>

			<!--
			<py-script > 
					
					#output="foliumMap" in py-script tag

					from gis01 import *

					#js.barLoading.style.width = "100%"; 
					#js.barLoading.innerHTML = "Loading ... 100%"; 

			</py-script>
			-->

			<script>
				//var mm = Object.values(window).find(obj => obj && obj._leaflet_id && obj.getContainer());
				//var mm = Object.values(window).find(obj => obj && obj._leaflet_id && obj.getContainer() );

				//console.log( Object.values(window) )
				//console.log( mm )

				//nameFoliumMap = ""; 


			</script>


			<div style=" clear: both">
				<br>
			</div>

			<div id="totQueryUfoDb" style="width: 100%; height: auto; "> <!-- border-style: solid;  -->
				<u>- Query SQL (Table 'Ufo') -</u>
				<br>
				<br>
				Scrivi una Query SQL (Table name 'UfoDb'): 
				<br>
				<div>
					<textarea id= "txt_queryUfoDb" style="width: 85%; height: 10vh; resize: none; float: left; font-family: 'Trebuchet MS'; font-weight:bold; font-size: 2.00vh; " >select * from UfoDb where year(date) = 1988 -- example</textarea>
					<button id="btn_executeQueryUfoDb" style="width: 14%; height: 10vh; float: right; font-family: 'Trebuchet MS';" 
						onclick="eseguiQueryUfoDb( '' + document.getElementById('txt_queryUfoDb').value )" >Esegui Query UfoDb</button> <!-- Accetta value NON innerHTML -->
				</div>

				<div style=" clear: both">
					<br>
				</div>

				<u>- Risultato della Query SQL -</u>
				<br>
				<br>
				<!-- <textarea id= "txt_resQueryUfoDb" style="width: 100%; height: 50vh; resize: none; overflow: scroll; white-space: pre; font-family: 'Trebuchet MS';" readonly ></textarea> -->
				<div id="div_resQueryUfoDb" style="height: 50vh; font-size: 1.75vh; " ></div>
				<button onclick="excelMap02()" style="margin-top: 0.5%; margin-left: 78.5%; width: 20%; ">Download Table Data (.xlsx)</button>
				<br>

			</div>

		</div>

		<script type="text/javascript">

			ufoDb = null;
			ufoDbResultQuery = null;

			div_resQueryUfoDb = null; //Tabulator JS

			/*
			var redMarker = L.AwesomeMarkers.icon({
				//icon: 'coffee',
				markerColor: 'red'
  			});
			*/

			var cluMarkers = L.markerClusterGroup();

			(async () => {
				await primoAvvio(); 
				//in relazione al primo avvio 
				await eseguiQueryUfoDb( "" ); //anno 1987 //arg vuoto
			})()

			async function primoAvvio() {

				//SET AUTOCOMMIT ON

				alasql.fn.myDate = function ( arg ) { //myfn
					//return( arg.split( " " )[0] ); 
					var arrDate = arg.split( " " )[ 0 ]; 
					//var arrTime = arg.split( " " )[ 1 ]; 
					var  tempSplitArrDate = arrDate.split( "/" ); 
					var mm = tempSplitArrDate[ 0 ]; mm = ( "0" + mm).slice(-2); 
					var dd = tempSplitArrDate[ 1 ]; dd = ( "0" + dd ).slice(-2); 
					var yyyy = tempSplitArrDate[ 2 ];
					var tempRes = yyyy + "/" + mm + "/" + dd;  
					return tempRes;  
				};

				alasql.fn.myTime = function ( arg ) { //myfn
					return( arg.split( " " )[ 1 ] );
				}
			
				await alasql.promise([
					'CREATE TABLE Tab (original_datetime string, city string, state string, country string, shape string, duration_seconds string, duration_text string, description string, report_date string, latitude string, longitude string) ',
					'SELECT [0] as original_datetime, [1] as city, [2] as state, [3] as country, [4] as shape, [5] as duration_seconds, [6] as duration_text, [7] as description, [8] as report_date, [9] as latitude, [10] as longitude INTO Tab FROM CSV("https://geoinf25.github.io/site/GIS/UfoDataset.csv",{headers:false})',
					'ALTER TABLE Tab ADD COLUMN date STRING',
					'ALTER TABLE Tab ADD COLUMN time STRING',
					'UPDATE Tab SET date = myDate( original_datetime ) ',
					'UPDATE Tab SET time = myTime( original_datetime ) ',
					//'SELECT * FROM Tab'
					'SELECT date, time, original_datetime, city, state, country, shape, duration_seconds, duration_text, description, report_date, latitude, longitude FROM Tab'           
					
				]).then(function (res) {
					ufoDb = res[6]; //JSON result
				
					console.log( ufoDb ); 
					//document.getElementById( "txt_resQueryUfoDb" ).innerHTML = JSON.stringify( json , null , 11 ); 
				}); 
			
			}
			
			async function eseguiQueryUfoDb( arg ) {
				var query = "";  
				if( arg === "" ) {
					query = 'SELECT * FROM ? WHERE YEAR(date) = '+document.getElementById("txt_annoAvvistamentoUFO").value;
				} else {
					query = arg.replaceAll( "UfoDb" , "?" ); 
				}
				
				try {
					//await alasql.promise( "SELECT * FROM ? WHERE YEAR(date) = "+document.getElementById("txt_annoAvvistamentoUFO").value , [ ufoDb ])
					await alasql.promise( query , [ ufoDb ])
						.then( function( result ) {
							//console.log( fin[0] ); 
							//document.getElementById( "txt_resQueryUfoDb" ).innerHTML = "" + fin[0]["datetime"]; 
							ufoDbResultQuery = result;
							console.log( ufoDbResultQuery );

							div_resQueryUfoDb = new Tabulator( "#div_resQueryUfoDb", {
								data: ufoDbResultQuery, // Carica i dati JSON
								autoColumns: true, // Crea automaticamente le colonne in base alle chiavi del JSON
							});

							//Aggiunta Marker sulla Mappa

							if( ufoDbResultQuery.length == 0 || ufoDbResultQuery[ 0 ][ "latitude" ] == undefined || ufoDbResultQuery[ 0 ][ "longitude" ] == undefined ) {
								document.getElementById( "consoleMap02" ).value += "- No Lat / Lng found ... see possible previous results on map ... \n";

							} else {

								document.getElementById( "consoleMap02" ).value += "- There are " + ufoDbResultQuery.length + " Markers on map for year " + document.getElementById("txt_annoAvvistamentoUFO").value + "... \n";

								if( layerMarkers.hasLayer( cluMarkers ) ) {
									layerMarkers.removeLayer( cluMarkers ); 
								}
								//cluMarkers = L.markerClusterGroup();
								cluMarkers.clearLayers();

								for( var i = 0;  i < ufoDbResultQuery.length; i++ ) {
									//tempMarker = L.marker([ ufoDbResultQuery[ i ][ "latitude" ] , ufoDbResultQuery[ i ][ "longitude" ] ] , {icon: redMarker} ).bindPopup("MARKER!");
									var tempTextPopup = `
										<div>
											<li><b>Datetime:</b> ${ufoDbResultQuery[ i ][ "date" ]} - ${ufoDbResultQuery[ i ][ "time" ]}</li>
											<li><b>City:</b> ${ufoDbResultQuery[ i ][ "city" ]}</li>
											<li><b>Shape:</b> ${ufoDbResultQuery[ i ][ "shape" ]}</li>
											<li><b>Duration:</b> ${ufoDbResultQuery[ i ][ "duration_text" ]}</li>
											<b>DESCRIPTION:</b> ${ufoDbResultQuery[ i ][ "description" ]}
										</div>
									`; 

									var tempMarker = L.marker([ ufoDbResultQuery[ i ][ "latitude" ] , ufoDbResultQuery[ i ][ "longitude" ] ] ).bindPopup( tempTextPopup );
									cluMarkers.addLayer( tempMarker );
								}

								layerMarkers.addLayer( cluMarkers ); 

							}

							//click_elements[ click_elements.length - 1 ].click(); //layerMarkers
							//if( click_elements[ click_elements.length - 1 ].value == "on" ) {
							//}

						}); 

				} catch( e ) {
					document.getElementById( "txt_queryUfoDb" ).value += " " + ( "" + e ); //NON innerHTML
				}

			}

			async function excelMap02() {
				var copyUfoDbResultQuery = JSON.parse(JSON.stringify(ufoDbResultQuery)); //copy of JSON

				copyUfoDbResultQuery.forEach(function(row) {
    				for (var key in row) {
        				// Sostituisce null/undefined con una stringa vuota 
        				if (row[key] === null || row[key] === undefined) {
            				row[key] = ""; 
        				}
						//Da verificare eventuali caratteri di controllo \u0000-\u0008\u000B- ... 
					}
				}); 

				await alasql.promise( "SELECT * INTO XLSX( 'excelTableMap02.xlsx' , {headers:true} ) FROM ? " , [ copyUfoDbResultQuery ]); //Dati Tabella ottenuti dalla Query

			}

		</script>

	</div>

	<br>
	<br>

	<div id = "blocco02GIS" class = "span4 roundBorder" >
		<u>GeoJSON (CRS EPSG 3857 (Tile Layer) / 4326 (L.geoJSON) ) </u>
		<br>
		<br>
		- Link di riferimento: <a href="https://ec.europa.eu/eurostat/web/gisco/geodata/administrative-units/countries">GISCO - GeoData - Countries (EPSG 4326)</a>, <a href="https://colorbrewer2.org/">Gradazione colori (Colorbrewer2)</a>, <a href="https://leafletjs.com/examples/choropleth/">Leafletjs choropleth</a>
		<br>
		- Mappa COROPLETICA legata all'estensione in Area dei vari Stati nazionali
		<br>
		*** Nota: i filtri consentono di ricercare i relativi nominativi, oppure le aree aventi valore <u>inferiore</u> a quanto indicato; il "click" sulla riga (in Tabella) consente di evidenziare la nazione coinvolta.
		<br>
		<br>
		<div id="contMap03">
			<div id="leafletMap03" style="float: left; height: 60vh; width: 52%; border: 2px solid " ></div> 
			<div id="div_dataCountr" style="float: left; margin-left: 0.5%; height: 60vh; width: 46%; font-size: 1.50vh; " ></div>
			<button onclick="excelMap03()" style="margin-top: 0.5%; margin-left: 78.5%; width: 20%; ">Download Table Data (.xlsx)</button>

			<!-- 
				<div style=" clear: both">
					<br>
				</div>
			-->

		</div>

		<script>

			var dataCountrTable = [ ]; 
			var countrData = null; 
			var layerCountr = null; 

			var map03 = L.map('leafletMap03' , { 
				zoomSnap: 1 , //1
				zoomDelta : 1, 
				wheelPxPerZoomLevel: 90, //60 

			} ).setView([ 46.035235, 10.980633], 1);

			var baseOSMMap03 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
			}).addTo(map03);

			function getColor( area ) {
				//var rifArea = 2442857;
				
				if( area > (10000000) ) {
					return "#ffffd9"; 
				} else if( area > (5000000) ) { 
					return "#edf8b1"; 
				} else if( area > (1000000) ) {
					return "#c7e9b4"; 
				} else if( area > (100000) ) {
					return "#7fcdbb";
				} else if( area > (10000) ) {
					return "#41b6c4";
				} else if( area > (1000) ) {
					return "#1d91c0";
				} else if( area > (100) ) {
					return "#225ea8"; 
				} else {
					return "#0c2c84"; 
				}
			}

			function fooStyle(feature) { 
				return {
					fillColor: getColor( turf.area(feature) / 1000000 ), //mq -> Km^2
					fillOpacity: 0.7, 
				}
			}

			var legend = L.control({position: 'bottomright'});

			legend.onAdd = function (map03) {
				var div = L.DomUtil.create( "div" , "" ); //div , class ... 
				div.style.background = "white"; 
				div.style.border = "solid 1px"; 
				div.style.fontFamily = "trebuchet ms"; 
				div.innerHTML = "<b>Area (Km^2)</b><br>";
				div.innerHTML += "<i style='background: #ffffd9'>&nbsp&nbsp</i> >10'000'000<br>";
				div.innerHTML += "<i style='background: #edf8b1'>&nbsp&nbsp</i> 5'000'000-10'000'000<br>";
				div.innerHTML += "<i style='background: #c7e9b4'>&nbsp&nbsp</i> 1'000'000-5'000'000<br>";
				div.innerHTML += "<i style='background: #7fcdbb'>&nbsp&nbsp</i> 100'000-1'000'000<br>";
				div.innerHTML += "<i style='background: #41b6c4'>&nbsp&nbsp</i> 10'000-100'000<br>";
				div.innerHTML += "<i style='background: #1d91c0'>&nbsp&nbsp</i> 1'000-10'000<br>";
				div.innerHTML += "<i style='background: #225ea8'>&nbsp&nbsp</i> 100-1'000<br>";
				div.innerHTML += "<i style='background: #0c2c84'>&nbsp&nbsp</i> 0-100<br>";
				return div;
			};

			legend.addTo(map03);

			async function avvioMap03() {
				try {
					const response = await fetch( "./GIS/Map03_CNTR_RG_20M_2024_4326.geojson" );
					countrData = await response.json(); 

					console.log( "Map03 CRS: " + map03.options.crs.code ); 
					//L.geoJSON in EPSG:4326 - WGS84 (si presume conversione automatica su Tile Layer EPSG 3857)
					//Turf.js in EPSG:4326 - WGS84
					//console.log( "Data GeoJSON 3857: " + countrData ); 
					console.log(  "Tot features in GeoJson: " + countrData.features.length);

					const swissFormatter = new Intl.NumberFormat('de-CH');

					layerCountr = L.geoJSON( countrData , {
						//coordsToLatLng: function (coords) {
							// Converte le coordinate proiettate [x, y] in [lat, lng]
							//return L.CRS.EPSG3857.unproject(L.point(coords));
						//},
						onEachFeature: function (feature, layer) {
							var areaCountr = parseFloat( ( turf.area(feature) / 1000000 ).toFixed(2) );
							dataCountrTable.push( 
								{ 
									"Name": feature.properties.NAME_ENGL, 
									"Sovereignty": feature.properties.SVRG_UN, 
									"Capital": feature.properties.CAPT, 
									"Area (Km^2)": areaCountr, 
								}
							); 
							layer.bindPopup(`
								<div>
									<li><b>NAME_ENGL -</b> ${feature.properties.NAME_ENGL}</li>
									<li><b>SVRG_UN -</b> ${feature.properties.SVRG_UN}</li>
									<li><b>CAPT -</b> ${feature.properties.CAPT}</li>
									<li><b>AREA (calculated sq.km) -</b> ${ swissFormatter.format( areaCountr ) }</li>
								</div>
							`)
						}, 
						style: fooStyle,

					}).addTo(map03);

				} catch (error) {
					console.log("Errore nel caricamento del GeoJSON:", error);
				}
			}

			//Avvio map03
			(async () => {
				await avvioMap03(); 

				//Elaborazione dataCountrTable ...

				div_dataCountr = new Tabulator( "#div_dataCountr", {
					data: dataCountrTable, // Carica i dati JSON
					//autoColumns: true, // Crea automaticamente le colonne in base alle chiavi del JSON
					columns: [
       					{title: "Name", field: "Name", headerFilter: "input", headerFilterParams: { elementAttributes: { style: "width: 100%; font-size: 1.5vh;" } } },
       					{title: "Sovereignty", field: "Sovereignty", headerFilter: "input", headerFilterParams: { elementAttributes: { style: "width: 100%; font-size: 1.5vh;" } } },
        				{title: "Capital", field: "Capital", headerFilter: "input", headerFilterParams: { elementAttributes: { style: "width: 100%; font-size: 1.5vh;" } } }, 
						{title: "Area (Km^2)", field: "Area (Km^2)", headerFilter: "number", headerFilterFunc: "<=", headerFilterParams: { elementAttributes: { style: "width: 100%; font-size: 1.5vh;" } } }, 
    				]
				});

				//countrData
				div_dataCountr.on("rowClick", function(e, row) {
					layerCountr.eachLayer(function ( singleCountr ) { //gruppo di Layer -> singolo Layer
  						if ( singleCountr.feature.properties.NAME_ENGL === row.getData().Name ) {
							// Zoom to that layer.
							map03.fitBounds( singleCountr.getBounds());
  						}
					});
				});

			})(); 

			async function excelMap03() {
				var copyDataCountrTable = JSON.parse(JSON.stringify(dataCountrTable)); //copy of JSON

				copyDataCountrTable.forEach(function(row) {
    				for (var key in row) {
        				// Sostituisce null/undefined con una stringa vuota 
        				if (row[key] === null || row[key] === undefined) {
            				row[key] = ""; 
        				}
						//Da verificare eventuali caratteri di controllo \u0000-\u0008\u000B- ... 
					}
				}); 

				await alasql.promise( "SELECT * INTO XLSX( 'excelTableMap03.xlsx' , {headers:true} ) FROM ? " , [ copyDataCountrTable ]); //Dati Tabella; countrData -> Dati GeoJSON

			}

		</script>
	</div>

	<br>
	<br>

	<div id = "blocco03GIS" class = "span4 roundBorder" >
		<u>Street View Map</u>
		<br>
		<br>
		- Link di riferimento: <a href="https://kartaview.org/landing">Karta View</a>, <a href="https://kartaview.org/doc/photos">Karta View - Photos (API)</a>
		<br>
		- Mappa contenente Immagini stradali entro una BB (Bounding Box) di lato pari a (circa) 500 metri.
		<br>
		*** Nota: esegui una ricerca entro i limiti della BB (Bounding Box) centrata sulla mappa, clicca sui Marker per visualizzare le immagini recuperate dal Servizio Karta View (NON tutte le aree visualizzate in mappa potrebbero essere effettivamente coperte dal Servizio Karta View).
		<br>
		<br>
		<div id="contMap04">
			<div style="float: left; width: 55%;" >
				<div id="leafletMap04" style="height: 70vh; border: 2px solid; " ></div> 
				<button type="button" id="button_searchPhotosMap04" style="height: 3vh; width: 100%; " onclick = "searchPhotosMap04()" ><b>Search Photos on Karta View</b></button>
			</div>
			<div id="contImageMarkerMap04" style="float: right; height: 73vh; width: 44%; display: flex; align-items: center; border: 2px solid; ">
				<img id="imageMarkerMap04" src="" alt= "" style="width: 100%; height: auto; " >
			</div>
			<div style=" clear: both">
				<br>
			</div>
		</div>

		<script>
			var map04 = L.map('leafletMap04' , { 
				zoomSnap: 1 , //1
				zoomDelta : 1, 
				wheelPxPerZoomLevel: 90, //60 

			} ).setView([ 45.870770, 10.876221 ], 16 );

			var baseOSMMap04 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
			}).addTo(map04);

			var centerMap04 = null;  
			var bboxTurf = null; 
			var bboxMap04 = null; 
			var arrMarkerMap04 = []; 

			function addBBoxMap04( ) {

				centerMap04 = map04.getCenter();
				var centerMap04Lat = centerMap04.lat;
				var centerMap04Lng = centerMap04.lng;

				var centerTurf = [ centerMap04Lng , centerMap04Lat ]; // [lng, lat]
				var pointCenterTurf = turf.point( centerTurf );
				//Crea un buffer di 250 metri (per avere un lato totale di 500 metri )
				//Usiamo 'steps: 4' per approssimare un quadrato orientato
				var bufferedTurf = turf.buffer( pointCenterTurf , 0.25, { units: 'kilometers' , steps: 4 } );
				bboxTurf = turf.bbox( bufferedTurf ); // Restituisce [minX, minY, maxX, maxY]

				//Ulteriore BBox / poligono GeoJSON per Leaflet
				var bboxPolyTurf = turf.bboxPolygon( bboxTurf );

				//Raffigurazione sulla mappa (Leaflet)
				bboxMap04 = L.geoJSON( bboxPolyTurf , {
    				style: {
        				color: "#ff7800",
        				weight: 2,
        				fillOpacity: 0.2
    				}
				}); 

				bboxMap04.addTo(map04); 

			}

			async function getPhotosBBoxMap04() {
				try {
					//radius NON utilizzato in API version 2.0

					const baseUrlMap04 = 'https://api.openstreetcam.org/2.0/photo/';

					const paramsMap04 = new URLSearchParams({
  						nwLat: bboxTurf[3], //nwLat , nwLng //maxLat, minLng
  						nwLng: bboxTurf[0],
  						seLat: bboxTurf[1], //seLat, seLng //minLat, maxLng
  						seLng: bboxTurf[2],
						page: 2, //Page number for pagination (default: 1).
  						ipp: 150, //Number of items per page (default: 50, max: 150).
					});

					const responseOSCMap04 = await fetch(`${baseUrlMap04}?${paramsMap04}`, { 
      					signal: AbortSignal.timeout(5000) // Timeout di 5 secondi
    				});

					jsonPhotosMap04 = await responseOSCMap04.json(); 
					console.log( jsonPhotosMap04 ); 

					if( jsonPhotosMap04 != null && jsonPhotosMap04.result?.data != undefined ) { //Attenzione "?"
						jsonPhotosMap04.result.data.forEach( (ele, index) => { //result.data[0]. ... 
							var tempMarker = L.marker([ ele.lat , ele.lng ] , { //options
								imageUrl : ele.fileurlLTh,  
							});
							tempMarker.bindPopup(`
								<div style="text-align: center;">
								<img src="${ele.fileurlLTh}" alt="OpenStreetCam Image ${index}" style="width: 30vh; height: auto; border: 2px solid;">
								<p>
									<b>Coordinates (lat/lng)</b>: ${ele.lat} :: ${ele.lng}
									<br>
									<b>Datetime</b>: ${ele.dateAdded}
									<br>
									<b>Marker index</b>: ${index}
								</p>
								</div>
							`);
							tempMarker.on('click', function( e ) {
								document.getElementById( "imageMarkerMap04" ).src = this.options.imageUrl;  
							}); 
							arrMarkerMap04.push( tempMarker ); 
						}); 
						arrMarkerMap04.forEach( (ele, index) => { 
							ele.addTo( map04 );  
						});  
					} else {
						var tempMarker = L.marker([ centerMap04.lat, centerMap04.lng ] );
						tempMarker.bindPopup(`
							<div style="text-align: center;">
								No photos found!
							</div>
							`
						); 
						arrMarkerMap04.push( tempMarker ); 
						arrMarkerMap04[ 0 ].addTo( map04 ); 
					}

				} catch( e ) {
					console.log( e );  
				}
			}

			( async () => { 
				await ( async () => { addBBoxMap04();  })();  //primo Avvio con Promise - Versione super compatta (Async)
				await ( async () => { getPhotosBBoxMap04(); })();  //primo Avvio
				arrMarkerMap04[ 0 ].fire('click'); //primo Avvio
			})();

			function searchPhotosMap04() { //map04.on('dragend', function(e) { //moveend
    			console.log("Nuovo centro:", map04.getCenter());

				if( bboxTurf != null ) {
					bboxTurf = null;  
				}
				if( bboxMap04 != null ) {
					map04.removeLayer( bboxMap04 );  
					bboxMap04 = null; 
				}
				addBBoxMap04(); 

				if( arrMarkerMap04.length > 0 ) {
					arrMarkerMap04.forEach( (ele, index) => { 
						map04.removeLayer( ele );  
					});  
					arrMarkerMap04 = [ ];
				}
				getPhotosBBoxMap04();

			};

		</script>
		
	</div>

	<br>
	<br>

	<div id = "blocco04GIS" class = "span4 roundBorder" >
		<u>Mappe QGIS</u>
		<br>
		<br>
		Link di riferimento: <a href="https://www.qgistutorials.com/en/docs/3/making_a_map.html">Spatial Thoughts - QGIS Tutorials</a>
		<br>
		<br>
		<div id="blocco01Map" style="width: 98%; height: 70vh; " > <!-- span1 --> <!-- class="span4 roundBorder"  -->
			<iframe src="https://geoinf25.github.io/site/GIS/MapQGIS01.pdf#view=fit" type="application/pdf" allow="fullscreen" width="100%" height="100%" ></iframe>
		</div>
		<br>
	</div>

</body>


</html>

